{% extends "base.html" %}

{% block title %}Timetable - {{ generation.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>
                    <i class="fas fa-calendar-alt me-2"></i>{{ generation.name }}
                </h1>
                <p class="text-muted mb-0">
                    Generated on {{ generation.created_at.strftime('%B %d, %Y at %H:%M') }}
                    <span class="badge bg-{{ 'success' if generation.status == 'generated' else 'danger' }} ms-2">
                        {{ generation.status.title() }}
                    </span>
                </p>
            </div>
            <div>
                <a href="{{ url_for('export_timetable', generation_id=generation.id) }}" 
                   class="btn btn-success me-2">
                    <i class="fas fa-download me-2"></i>Export Excel
                </a>
                <a href="{{ url_for('generate') }}" class="btn btn-primary">
                    <i class="fas fa-magic me-2"></i>Generate New
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Timetable Views Tabs -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="timetableTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="student-tab" data-bs-toggle="tab" 
                                data-bs-target="#student-view" type="button" role="tab">
                            <i class="fas fa-graduation-cap me-2"></i>Student View
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="faculty-tab" data-bs-toggle="tab" 
                                data-bs-target="#faculty-view" type="button" role="tab">
                            <i class="fas fa-chalkboard-teacher me-2"></i>Faculty View
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="room-tab" data-bs-toggle="tab" 
                                data-bs-target="#room-view" type="button" role="tab">
                            <i class="fas fa-door-open me-2"></i>Room View
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="timetableTabContent">
                    <!-- Student View -->
                    <div class="tab-pane fade show active" id="student-view" role="tabpanel">
                        <h5 class="mb-3">Student Timetable</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="120">Time</th>
                                        {% for day in days %}
                                            <th class="text-center">{{ day }}</th>
                                        {% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for slot in time_slots %}
                                        {% if slot.day == 'Monday' %}
                                            <tr>
                                                <td class="fw-bold">
                                                    {{ slot.start_time | time12 }} TO {{ slot.end_time | time12 }}
                                                </td>
                                                {% for day in days %}
                                                    <td class="text-center">
                                                        {% set schedule = timetable_grid[day][slot.period_number] %}
                                                        {% if schedule %}
                                                            <div class="p-2 bg-primary bg-opacity-10 rounded">
                                                                <strong>{{ schedule.course.code }}</strong><br>
                                                                <small>{{ schedule.course.name }}</small><br>
                                                                <small class="text-muted">
                                                                    <i class="fas fa-user me-1"></i>{{ schedule.faculty.name }}<br>
                                                                    <i class="fas fa-door-open me-1"></i>{{ schedule.room.number }}
                                                                </small>
                                                            </div>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Faculty View -->
                    <div class="tab-pane fade" id="faculty-view" role="tabpanel">
                        <h5 class="mb-3">Faculty-wise Timetables</h5>
                        {% for faculty_name, faculty_schedule in faculty_timetable.items() %}
                            <div class="mb-4">
                                <h6 class="text-primary">
                                    <i class="fas fa-user me-2"></i>{{ faculty_name }}
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th width="100">Time</th>
                                                {% for day in days %}
                                                    <th class="text-center">{{ day }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for slot in time_slots %}
                                                {% if slot.day == 'Monday' %}
                                                    <tr>
                                                        <td class="small fw-bold">{{ slot.start_time | time12 }} TO {{ slot.end_time | time12 }}</td>
                                                        {% for day in days %}
                                                            <td class="text-center">
                                                                {% set schedule = faculty_schedule[day][slot.period_number] %}
                                                                {% if schedule %}
                                                                    <div class="small p-1 bg-success bg-opacity-10 rounded">
                                                                        <strong>{{ schedule.course.code }}</strong><br>
                                                                        <span class="text-muted">{{ schedule.room.number }}</span>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted small">Free</span>
                                                                {% endif %}
                                                            </td>
                                                        {% endfor %}
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Room View -->
                    <div class="tab-pane fade" id="room-view" role="tabpanel">
                        <h5 class="mb-3">Room-wise Timetables</h5>
                        {% for room_number, room_schedule in room_timetable.items() %}
                            <div class="mb-4">
                                <h6 class="text-info">
                                    <i class="fas fa-door-open me-2"></i>{{ room_number }}
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered table-sm">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th width="100">Time</th>
                                                {% for day in days %}
                                                    <th class="text-center">{{ day }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for slot in time_slots %}
                                                {% if slot.day == 'Monday' %}
                                                    <tr>
                                                        <td class="small fw-bold">{{ slot.start_time | time12 }} TO {{ slot.end_time | time12 }}</td>
                                                        {% for day in days %}
                                                            <td class="text-center">
                                                                {% set schedule = room_schedule[day][slot.period_number] %}
                                                                {% if schedule %}
                                                                    <div class="small p-1 bg-warning bg-opacity-10 rounded">
                                                                        <strong>{{ schedule.course.code }}</strong><br>
                                                                        <span class="text-muted">{{ schedule.faculty.name }}</span>
                                                                    </div>
                                                                {% else %}
                                                                    <span class="text-muted small">Available</span>
                                                                {% endif %}
                                                            </td>
                                                        {% endfor %}
                                                    </tr>
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Statistics -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-book fa-2x text-primary mb-2"></i>
                <h5>{{ schedules | length }}</h5>
                <small class="text-muted">Total Classes</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-chalkboard-teacher fa-2x text-success mb-2"></i>
                <h5>{{ faculty_timetable.keys() | list | length }}</h5>
                <small class="text-muted">Faculty Involved</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-door-open fa-2x text-info mb-2"></i>
                <h5>{{ room_timetable.keys() | list | length }}</h5>
                <small class="text-muted">Rooms Used</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                <h5>{{ time_slots | selectattr('day', 'equalto', 'Monday') | list | length * 5 }}</h5>
                <small class="text-muted">Available Slots</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Print functionality
function printTimetable() {
    window.print();
}

// Auto-refresh for real-time updates (if needed)
document.addEventListener('DOMContentLoaded', function() {
    // Any additional JavaScript for interactivity
    console.log('Timetable loaded successfully');
});
</script>
{% endblock %}
